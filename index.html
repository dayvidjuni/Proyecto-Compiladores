<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visual Novel Studio - IDE</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Bebas+Neue&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <nav id="main-nav">
        <div class="nav-top">
            <button class="nav-btn active" data-view="editor" title="Editor">
                <span class="nav-icon">&lt;/&gt;</span>
            </button>
            <button class="nav-btn" data-view="analysis" title="An√°lisis IA">
                <span class="nav-icon">üß†</span>
            </button>
            <button class="nav-btn" data-view="community" title="Comunidad">
                <span class="nav-icon">üåê</span>
            </button>
            <button class="nav-btn" data-view="docs" title="Documentaci√≥n">
                <span class="nav-icon">?</span>
            </button>
        </div>
        <div class="nav-bottom">
            <button class="nav-btn" data-view="profile" title="Perfil">
                <span class="nav-icon">üë§</span>
            </button>
        </div>
    </nav>

    <div id="app-content">

        <div id="view-editor" class="view view-active">
            <div class="editor-grid">
                
                <div id="project-panel" class="panel">
                    <div class="panel-header">
                        <h3>Proyecto</h3>
                    </div>
                    <div class="panel-content">
                        <div class="file-tree">
                            <div class="file-item"><span class="file-icon">üìÑ</span><span>script.game</span></div>
                            <div class="file-item"><span class="file-icon">üñºÔ∏è</span><span>assets</span></div>
                            <div class="file-item"><span class="file-icon">üîä</span><span>audio</span></div>
                        </div>
                        <hr style="margin: 15px 0; border: none; border-top: 1px solid #333;">
                        <h4>Gestor de Assets</h4>
                        <input type="text" id="asset-url-input" placeholder="Link de imagen/audio..." class="asset-input">
                        <button id="asset-url-btn" class="asset-btn">Usar Link</button>
                        <label for="asset-file-input" class="asset-btn" style="margin-top:5px; display:block; text-align:center;">üìÅ Subir Archivo</label>
                        <input type="file" id="asset-file-input" accept="image/*, audio/*" style="display: none;">
                        <div id="asset-output-container" style="display:none; margin-top: 10px; padding: 10px; background: #222; border: 1px solid var(--accent-neon);">
                            <p style="font-size: 10px; margin: 0; color: var(--accent-neon);">‚úì URL Copiada:</p>
                            <code id="asset-output-text" style="font-size: 10px; word-break: break-all; color: var(--accent-cyan);"></code>
                        </div>
                    </div>
                </div>

                <div id="code-panel" class="panel">
                    <div class="panel-header">
                        <h3>script.game</h3>
                        <button id="load-script-btn" class="compile-btn">‚ñ∂ Compilar</button>
                    </div>
                    <div class="panel-content" style="padding:0;">
                        <div class="editor-wrapper">
                            <div class="line-numbers" id="line-numbers">1</div>
                            <div class="code-container">
                                <pre id="syntax-highlight" aria-hidden="true"></pre>
                                <textarea id="script-input" spellcheck="false" placeholder="Escribe tu c√≥digo aqu√≠...">
game "Demo" {
    scene inicio {
        dialogue alice "Hola, bienvenido al motor."
        choice {
            "Ir al bosque" -> { goto bosque; }
            "Quedarse" -> { dialogue alice "Nos quedamos."; }
        }
    }
    scene bosque {
        dialogue alice "Esto es un bosque oscuro."
    }
}</textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="right-split-panel" class="panel">
                    
                    <div id="preview-section">
                        <div class="panel-header">
                            <h3>Vista Previa</h3>
                            <div class="preview-controls">
                                <button id="btn-undo" class="control-btn" title="Atr√°s">‚Üê</button>
                                <button id="btn-redo" class="control-btn" title="Adelante">‚Üí</button>
                            </div>
                        </div>
                        <div id="game-screen">
                            <div id="character-layer"></div>
                            <div id="dialogue-box">
                                <div id="speaker-name"></div>
                                <div id="dialogue-text">Pulsa Compilar para iniciar...</div>
                                <div id="choice-buttons"></div>
                                <button id="continue-btn">‚Üí</button>
                            </div>
                        </div>
                    </div>

                    <div id="flow-section">
                        <div class="panel-header" style="border-top: 1px solid #333;">
                            <h3>Mapa de Flujo</h3>
                            <span style="font-size: 10px; color: #666;">Auto-actualizable</span>
                        </div>
                        <div id="mini-map-container">
                            <div id="mermaid-chart-mini" class="mermaid">
                                graph TD; A[C√≥digo] --> B(Compilar) --> C{Jugar};
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <div id="view-analysis" class="view">
            <div class="analysis-layout">
                <div class="analysis-header">
                    <h1>An√°lisis Narrativo Avanzado</h1>
                    <button id="btn-run-analysis" class="compile-btn">ü§ñ Ejecutar Diagn√≥stico</button>
                </div>
                <div class="analysis-content">
                    <div class="stats-panel">
                        <h3 style="color: var(--accent-magenta); margin-bottom: 15px;">M√©tricas</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                            <div class="stat-card"><div id="stat-words" style="font-size: 20px; font-weight:bold; color:var(--accent-neon)">0</div><small>Palabras</small></div>
                            <div class="stat-card"><div id="stat-scenes" style="font-size: 20px; font-weight:bold; color:var(--accent-cyan)">0</div><small>Escenas</small></div>
                            <div class="stat-card"><div id="stat-choices" style="font-size: 20px; font-weight:bold; color:var(--accent-magenta)">0</div><small>Decisiones</small></div>
                            <div class="stat-card"><div id="stat-endings" style="font-size: 20px; font-weight:bold; color:var(--accent-orange)">0</div><small>Finales</small></div>
                        </div>
                        <h4 style="color: #ff4444; border-bottom: 1px solid #333;">Errores Cr√≠ticos</h4>
                        <ul id="list-errors" style="font-size:11px; color:#ff6666; list-style:none; padding:0; margin-top:5px;">
                            <li>Esperando an√°lisis...</li>
                        </ul>
                        <h4 style="color: var(--accent-neon); margin-top: 15px;">Complejidad</h4>
                        <div style="background:#333; height:8px; border-radius:4px; overflow:hidden;">
                            <div id="complexity-bar" style="width:0%; height:100%; background:linear-gradient(90deg, cyan, magenta);"></div>
                        </div>
                        <p id="complexity-text" style="text-align:right; font-size:10px; color:#ccc;">Nivel: --</p>
                    </div>
                    <div class="graph-panel">
                        <div id="mermaid-chart" class="mermaid">graph TD; A[Listo] --> B[Analizar];</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-community" class="view" style="padding:40px;">
            <h1>Comunidad</h1>
            <div class="stories-grid">
                <div class="story-card">
                    <div class="story-image">üìö</div>
                    <div class="story-info"><h4>Aventura Demo</h4><p>Usuario1</p></div>
                </div>
                </div>
        </div>

        <div id="view-docs" class="view">
            <div class="docs-sidebar"><h3>Indice</h3><a href="#" class="toc-link">Inicio</a></div>
            <div class="docs-content"><h1>Documentaci√≥n</h1><p>Bienvenido al manual.</p></div>
        </div>

        <div id="view-profile" class="view" style="padding:40px;">
            <h1>Perfil de Usuario</h1>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.4/howler.min.js"></script>
    
    <script src="compiler.js"></script>
    <script src="syntax-highlighter.js"></script>
    <script src="main.js"></script>

    <script>
        mermaid.initialize({ startOnLoad: true, theme: 'dark', securityLevel: 'loose' });

        document.addEventListener('DOMContentLoaded', () => {
            const compileBtn = document.getElementById('load-script-btn');
            compileBtn.addEventListener('click', () => {
                // Peque√±o delay para asegurar que el engine carg√≥
                setTimeout(updateMiniMap, 100);
            });
        });

        async function updateMiniMap() {
            const input = document.getElementById('script-input').value;
            const container = document.getElementById('mermaid-chart-mini');
            try {
                const lexer = new Lexer(input);
                const parser = new Parser(lexer);
                const ast = parser.parse();
                // Usamos el mismo Analyzer que creamos para el robot
                const analyzer = new StoryAnalyzer(ast);
                const result = analyzer.generateMermaid();
                
                container.removeAttribute('data-processed');
                container.innerHTML = result.code;
                await mermaid.run({ nodes: [container] });
            } catch (e) {
                console.log("Error actualizando mini-mapa (posible error de sintaxis)");
            }
        }
    </script>
</body>
</html>